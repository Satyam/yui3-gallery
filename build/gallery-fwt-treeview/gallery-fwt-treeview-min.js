YUI.add("gallery-fwt-treeview",function(e,t){"use strict";var n=e.Lang,r=e.Array,i=e.ClassNameManager.getClassName,s=function(e){return i("fw-treeview",e)},o={cname_toggle:s("toggle"),cname_icon:s("icon"),cname_selection:s("selection"),cname_sel_prefix:s("selected-state"),cname_label:s("label")},u="contentBox",a="expanded",f=0,l=1,c=2;e.FWTreeView=e.Base.create("fw-treeview",e.Widget,[e.FlyweightTreeManager],{_visibleSequence:null,_visibleIndex:null,initializer:function(e){this._domEvents=["click"],this._loadConfig(e.tree)},renderUI:function(){var e=this.get(u);e.setContent(this._getHTML()),e.set("role","tree")},bindUI:function(){this.get(u).on("keydown",this._onKeyDown,this)},_onKeyDown:function(e){var t=e.charCode,n=e.shiftKey,r=e.ctrlKey,i=this._focusedINode,s=this._visibleSequence,o=this._visibleIndex,u;console.log(t,n,r);switch(t){case 38:s||(s=this._rebuildSequence(),o=s.indexOf(i)),o-=1,o>=0?(i=s[o],this._visibleIndex=o):i=null;break;case 39:i.expanded?i.children&&i.children.length?i=i.children[0]:i=null:(this._poolReturn(this._poolFetch(i).set(a,!0)),i=null);break;case 40:s||(s=this._rebuildSequence(),o=s.indexOf(i)),o+=1,o<s.length?(i=s[o],this._visibleIndex=o):i=null;break;case 37:i.expanded&&i.children?(this._poolReturn(this._poolFetch(i).set(a,!1)),i=null):(i=i._parent,i===this._tree&&(i=null));break;case 36:i=this._tree.children&&this._tree.children[0];break;case 35:o=this._tree.children&&this._tree.children.length,o?i=this._tree.children[o-1]:i=null;break;case 13:u=this._poolFetch(i),u.fire("enterkey",{domEvent:e}),this._poolReturn(u),i=null;break;case 32:u=this._poolFetch(i),u.fire("spacebar",{domEvent:e}),this._poolReturn(u),i=null;break;case 106:this.expandAll();break;case 34:break;case 35:break;default:i=null}return i?(this._focusOnINode(i),e.halt(),!1):!0},_afterFocus:function(e){var t=this._findINodeByElement(e.domEvent.target);this._focusOnINode(t),this._visibleSequence&&(this._visibleIndex=this._visibleSequence.indexOf(t))},_rebuildSequence:function(){var e=[],t=function(n){r.each(n.children||[],function(n){e.push(n),n.expanded&&t(n)})};return t(this._tree),this._visibleSequence=e},CONTENT_TEMPLATE:"<ul></ul>"},{ATTRS:{defaultType:{value:"FWTreeNode"},toggleOnLabelClick:{value:!1,validator:n.isBoolean}}}),e.FWTreeNode=e.Base.create("fw-treenode",e.FlyweightTreeNode,[],{initializer:function(){this.after("click",this._afterClick),this.after("selectedChange",this._afterSelectedChange),this.after("spacebar",this.toggleSelection),this.after("expandedChange",this._afterExpandedChanged)},_afterExpandedChanged:function(){this._root._visibleSequence=null},_afterClick:function(e){var t=e.domEvent.target;t.hasClass(o.cname_toggle)?this.toggle():t.hasClass(o.cname_selection)?this.toggleSelection():(t.hasClass(o.cname_content)||t.hasClass(o.cname_icon))&&this.get("root").get("toggleOnLabelClick")&&this.toggle()},toggleSelection:function(){this.set("selected",this.get("selected")?f:c)},_afterSelectedChange:function(t){var n=t.newVal,r=o.cname_sel_prefix+"-";this.isRoot()||(e.one("#"+this.get("id")).replaceClass(r+t.prevVal,r+n),this.get("propagateUp")&&t.src!=="propagatingDown"&&this.getParent()._childSelectedChange().release()),this.get("propagateDown")&&t.src!=="propagatingUp"&&this.forSomeChildren(function(e){e.set("selected",n,"propagatingDown")})},_dynamicLoadReturn:function(){e.FWTreeNode.superclass._dynamicLoadReturn.apply(this,arguments);if(this.get("propagateDown")){var t=this.get("selected");this.forSomeChildren(function(e){e.set("selected",t,"propagatingDown")})}this._root._visibleSequence=null},_childSelectedChange:function(){var e=0,t=0;return this.forSomeChildren(function(n){e+=2,t+=n.get("selected")}),this.set("selected",t===0?f:t===e?c:l,{src:"propagatingUp"}),this}},{TEMPLATE:n.sub('<li id="{id}" class="{cname_node} {cname_sel_prefix}-{selected}" role="treeitem" aria-expanded="{expanded}"><div tabIndex="{tabIndex}" class="{cname_content}"><div class="{cname_toggle}"></div><div class="{cname_icon}"></div><div class="{cname_selection}"></div><div class="{cname_label}">{label}</div></div><ul class="{cname_children}" role="group">{children}</ul></li>',o),NOT_SELECTED:f,PARTIALLY_SELECTED:l,FULLY_SELECTED:c,ATTRS:{selected:{value:f,validator:function(e){return e===f||e===c||e===l}},propagateUp:{value:!0,validator:n.isBoolean},propagateDown:{value:!0,validator:n.isBoolean}}})},"@VERSION@",{requires:["gallery-flyweight-tree","widget","base-build"],skinnable:!0});
