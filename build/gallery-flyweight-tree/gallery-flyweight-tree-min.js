YUI.add("gallery-flyweight-tree",function(a,e){var d=a.Lang,m=".",b="_default",p=a.ClassNameManager.getClassName,f=function(s){return p("flyweight-tree-node",s);},q=f(""),l=f("children"),g=f("collapsed"),c=f("expanded"),o=f("no-children"),r=f("first-child"),k=f("last-child"),n=f("loading"),i=a.Array,h,j;h=function(){this._pool={};this._initialValues={};};h.ATTRS={defaultType:{value:"FlyweightTreeNode"},dynamicLoader:{validator:d.isFunction,value:null}};h.prototype={_tree:null,_pool:null,_domEvents:null,_loadConfig:function(s){var t=this;t._tree={children:a.clone(s)};t._initNodes(this._tree);if(t._domEvents){a.Array.each(t._domEvents,function(u){t.after(u,t._afterDomEvent,t);});}},_initNodes:function(t){var s=this;a.Array.each(t.children,function(u){u._parent=t;u.id=u.id||a.guid();s._initNodes(u);});},_afterDomEvent:function(t){var s=this._poolFetchFromEvent(t);if(s){s.fire(t.type.split(":")[1],{domEvent:t.domEvent});this._poolReturn(s);}},_getTypeString:function(t){var s=t.type||b;if(!d.isString(s)){if(d.isObject(s)){s=s.NAME;}else{throw"Node contains unknown type";}}return s;},_poolFetch:function(v){var t,s=v._held,u=this._getTypeString(v);if(s){return s;}t=this._pool[u];if(t===undefined){t=this._pool[u]=[];}if(t.length){s=t.pop();s._slideTo(v);return s;}return this._createNode(v);},_poolReturn:function(s){if(s._node._held){return;}var t,u=this._getTypeString(s._node);t=this._pool[u];if(t){t.push(s);}},_createNode:function(u){var t,s=u.type||this.get("defaultType");if(d.isString(s)){s=a[s];}if(s){t=new s();if(t instanceof a.FlyweightTreeNode){t._slideTo({});t.getAttrs();t._root=this;t._slideTo(u);return t;}}return null;},_getRootNode:function(){return this._poolFetch(this._tree);},_getHTML:function(){var u="",t=this._getRootNode();t.forEachChild(function(s,v,w){u+=s._getHTML(v,w.length,0);});this._poolReturn(t);return u;},_findNodeByElement:function(t){var v=t.ancestor(m+j.CNAME_NODE,true).get("id"),u=null,s=function(w){if(w.id===v){u=w;return true;}if(w.children){return a.Array.some(w.children,s);}return false;};if(s(this._tree)){return u;}return null;},_poolFetchFromEvent:function(s){var t=this._findNodeByElement(s.domEvent.target);if(t){return this._poolFetch(t);}return null;},_forSomeCfgNode:function(u,t){t=t||this;var s=function(w,v){return a.Array.some(w.children||[],function(y,x){u.call(t,y,v,x);return s(y,v+1);});};return s(this._tree,0);}};a.FlyweightTreeManager=h;j=a.Base.create("flyweight-tree-node",a.Base,[],{_node:null,_root:null,_getHTML:function(x,D,v){var B=this,w=function(){var H={},G,E,s,F=a.Object.keys(B._state.data);for(G=0,E=F.length;G<E;G+=1){s=F[G];H[s]=B.get(s);}return H;},t=this._node,A=w(),C="",y=t.template||this.constructor.TEMPLATE,u=t.children&&t.children.length,z=[q];t._rendered=true;if(u){if(A.expanded){t._childrenRendered=true;this.forEachChild(function(s,E,F){C+=s._getHTML(E,F.length,v+1);});z.push(c);}else{z.push(g);}}else{if(this._root.get("dynamicLoader")&&!t.isLeaf){z.push(g);}else{z.push(o);}}if(x===0){z.push(r);}else{if(x===D-1){z.push(k);}}A.children=C;A.cname_node=z.join(" ");A.cname_children=l;return d.sub(y,A);},_slideTo:function(s){this._node=s;this._stateProxy=s;},forEachChild:function(w,v){var s=this._root,u=this._node.children,x,t;v=v||this;if(u&&u.length){i.each(u,function(z,y,A){x=s._poolFetch(z);t=w.call(v,x,y,A);s._poolReturn(x);return t;});}},_expandedGetter:function(){return this._node.expanded!==false;},_expandedSetter:function(w){var t=this,v=t._node,s=t._root,u=a.one("#"+v.id),x=s.get("dynamicLoader");v.expanded=w=!!w;if(x&&!v.isLeaf&&(!v.children||!v.children.length)){this._loadDynamic();return;}if(v.children&&v.children.length){if(w){if(!v._childrenRendered){t._renderChildren();}u.replaceClass(g,c);}else{u.replaceClass(c,g);}}},_loadDynamic:function(){var t=this,s=t._root;a.one("#"+this.get("id")).replaceClass(g,n);s.get("dynamicLoader").call(s,t,a.bind(t._dynamicLoadReturn,t));},_dynamicLoadReturn:function(u){var t=this,v=t._node,s=t._root;if(u){v.children=u;s._initNodes(v);t._renderChildren();}else{v.isLeaf=true;}a.one("#"+v.id).replaceClass(n,(v.isLeaf?o:c));},_renderChildren:function(){var t="",u=this._node,v=this.get("depth");u._childrenRendered=true;this.forEachChild(function(s,w,x){t+=s._getHTML(w,x.length,v+1);});a.one("#"+u.id+" ."+l).setContent(t);},hold:function(){return(this._node._held=this);},release:function(){this._node._held=null;this._root._poolReturn(this);return this;},getParent:function(){var s=this._node._parent;return(s?this._root._poolFetch(s):null);},getNextSibling:function(){var t=this._node._parent,u=(t&&t.children)||[],s=u.indexOf(this)+1;if(s===0||s>u.length){return null;}return this._root._poolFetch(u[s]);},getPreviousSibling:function(){var t=this._node._parent,u=(t&&t.children)||[],s=u.indexOf(this)-1;if(s<0){return null;}return this._root._poolFetch(u[s]);},toggle:function(){this.set("expanded",!this.get("expanded"));return this;}},{TEMPLATE:'<div id="{id}" class="{cname_node}"><div class="content">{label}</div><div class="{cname_children}">{children}</div></div>',CNAME_NODE:q,CNAME_CHILDREN:l,CNAME_COLLAPSED:g,CNAME_EXPANDED:c,CNAME_NOCHILDREN:o,CNAME_FIRSTCHILD:r,CNAME_LASTCHILD:k,CNAME_LOADING:n,ATTRS:{root:{_bypassProxy:true,readOnly:true,getter:function(){return this._root;}},template:{validator:d.isString},label:{validator:d.isString,value:""},id:{readOnly:true},depth:{_bypassProxy:true,readOnly:true,getter:function(){var t=0,s=this._node;while(s._parent){t+=1;s=s._parent;}return t-1;}},expanded:{_bypassProxy:true,getter:"_expandedGetter",setter:"_expandedSetter"}}});a.FlyweightTreeNode=j;},"@VERSION@",{"requires":["base-base","base-build","classnamemanager"],"skinnable":false});