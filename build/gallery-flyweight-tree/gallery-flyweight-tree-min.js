YUI.add("gallery-flyweight-tree",function(e,t){"use strict";var n=e.Lang,r=e.Array,i=".",s="_bypassProxy",o="value",u="expanded",a="dynamicLoader",f="tabIndex",l="focused",c="_default",h=e.ClassNameManager.getClassName,p="flyweight-tree-node",d=h(p),v=function(e){return h(p,e)},m=v("content"),g=v("children"),y=v("collapsed"),b=v(u),w=v("no-children"),E=v("first-child"),S=v("last-child"),x=v("loading"),T,N;T=function(){this._pool={},this._initialValues={},this._eventHandles=[e.Do.after(this._doAfterRender,this,"render"),this.after("focus",this._afterFocus),this.on("destroy",this._onDestroy)]},T.ATTRS={defaultType:{value:"FlyweightTreeNode"},dynamicLoader:{value:null,setter:"_dynamicLoaderSetter"},focusedNode:{getter:"_focusedNodeGetter",setter:"_focusedNodeSetter"}},T.prototype={_tree:null,_pool:null,_domEvents:null,_focusedINode:null,_eventHandles:null,_loadConfig:function(t){this._tree={children:e.clone(t)},this._initNodes(this._tree)},_initNodes:function(t){var n=this,i=!!n.get(a);r.each(t.children,function(r){n._focusedINode||(n._focusedINode=r),r._parent=t,r.id=r.id||e.guid(),i&&!r.children?r.expanded=!!r.isLeaf:r.expanded=r.expanded===undefined||!!r.expanded,n._initNodes(r)})},_onDestroy:function(){r.each(this._pool,function(e){e.destroy()}),this._pool=null,r.each(this._eventHandles,function(e){e.detach()}),this._eventHandles=null},_doAfterRender:function(){var e=this;e._domEvents&&r.each(e._domEvents,function(t){e._eventHandles.push(e.after(t,e._afterDomEvent,e))}),e.fire=function(e){return function(t,n){var r;return n&&n.domEvent?(n.node=this._poolFetchFromEvent(n),r=e.call(this,t,n),this._poolReturn(n.node),r):e.call(this,t,n)}}(e.fire)},expandAll:function(){this._forSomeINode(function(e){e.children&&!e.expanded&&this._poolReturn(this._poolFetch(e).set(u,!0))})},_afterDomEvent:function(e){var t=e.node;t&&t.fire(e.type.split(":")[1],{domEvent:e.domEvent})},_getTypeString:function(e){var t=e.type||c;if(!n.isString(t)){if(!n.isObject(t))throw"Node contains unknown type";t=t.NAME}return t},_poolFetch:function(e){var t,n=e._held,r=this._getTypeString(e);return n?n:(t=this._pool[r],t===undefined&&(t=this._pool[r]=[]),t.length?(n=t.pop(),n._slideTo(e),n):this._createNode(e))},_poolReturn:function(e){if(e._iNode._held)return;var t,n=this._getTypeString(e._iNode);t=this._pool[n],t&&t.push(e)},_createNode:function(t){var i,s=t.type||this.get("defaultType");n.isString(s)&&(s=e[s]);if(s){i=new s({root:this});if(i instanceof e.FlyweightTreeNode)return i._slideTo({}),r.each(e.Object.keys(i._state.data),i._addLazyAttr,i),i._root=this,i._slideTo(t),i}return null},getRoot:function(){return this._poolFetch(this._tree)},_getHTML:function(){var e="",t=this.getRoot();return t.forSomeChildren(function(t,n,r){e+=t._getHTML(n,r.length,0)}),this._poolReturn(t),e},_findINodeByElement:function(e){var t=e.ancestor(i+N.CNAME_NODE,!0).get("id"),n=null,s=function(e){return e.id===t?(n=e,!0):e.children?r.some(e.children,s):!1};return s(this._tree)?n:null},_poolFetchFromEvent:function(e){var t=this._findINodeByElement(e.domEvent.target);return t?this._poolFetch(t):null},_forSomeINode:function(e,t){t=t||this;var n=function(i,s){return r.some(i.children||[],function(r,i){return e.call(t,r,s,i)?!0:n(r,s+1)})};return n(this._tree,0)},forSomeNodes:function(e,t){t=t||this;var n=function(r,i){r.forSomeChildren(function(r,s,o){return e.call(t,r,i,s,o)===!0?!0:n(r,i+1)})};return n(this.getRoot(),1)},_focusedNodeGetter:function(){return this._poolFetch(this._focusedINode)},_focusedNodeSetter:function(t){if(!t||t instanceof e.FlyweightTreeNode){var n=t?t._iNode:this._tree.children[0];return this._focusOnINode(n),n}return e.Attribute.INVALID_VALUE},_focusOnINode:function(t){var n=this._focusedINode,r;t&&t!==n&&(r=e.one("#"+n.id+" ."+m),r.blur(),r.set(f,-1),r=e.one("#"+t.id+" ."+m),r.focus(),r.set(f,0),this._focusedINode=t)},_dynamicLoaderSetter:function(t){return!n.isFunction(t)&&t!==null?e.Attribute.INVALID_VALUE:(t&&this._forSomeINode(function(e){e.children||(e.expanded=!!e.isLeaf)}),t)}},e.FlyweightTreeManager=T,N=e.Base.create(p,e.Base,[],{_iNode:null,_root:null,initializer:function(e){this._root=e.root},_getHTML:function(e,t,r){var i=this._root,s=this._iNode,o=this.getAttrs(),u="",f=s.template,l=s.children&&s.children.length,c=[d],h=this.constructor;while(!f)f=h.TEMPLATE,h=h.superclass.constructor;return s._rendered=!0,l?o.expanded?(s._childrenRendered=!0,this.forSomeChildren(function(e,t,n){u+=e._getHTML(t,n.length,r+1)}),c.push(b)):c.push(y):this._root.get(a)&&!s.isLeaf?c.push(y):c.push(w),e===0&&c.push(E),e===t-1&&c.push(S),o.children=u,o.cname_node=c.join(" "),o.cname_content=m,o.cname_children=g,o.tabIndex=s===i._focusedINode?0:-1,n.sub(f,o)},_slideTo:function(e){this._iNode=e,this._stateProxy=e},forSomeChildren:function(e,t){var n=this._root,i=this._iNode.children,s,o;t=t||this,i&&i.length&&r.some(i,function(r,i,u){return s=n._poolFetch(r),o=e.call(t,s,i,u),n._poolReturn(s),o})},_expandedGetter:function(){return this._iNode.expanded!==!1},_expandedSetter:function(t){var n=this,r=n._iNode,i=n._root,s=e.one("#"+r.id),o=i.get(a);r.expanded=t=!!t;if(o&&!r.isLeaf&&(!r.children||!r.children.length)){this._loadDynamic();return}r.children&&r.children.length&&(t?(r._childrenRendered||n._renderChildren(),s.replaceClass(y,b)):s.replaceClass(b,y)),s.set("aria-expanded",String(t))},_loadDynamic:function(){var t=this,n=t._root;e.one("#"+this.get("id")).replaceClass(y,x),n.get(a).call(n,t,e.bind(t._dynamicLoadReturn,t))},_dynamicLoadReturn:function(t){var n=this,r=n._iNode,i=n._root;t?(r.children=t,i._initNodes(r),n._renderChildren()):r.isLeaf=!0,e.one("#"+r.id).replaceClass(x,r.isLeaf?w:b)},_renderChildren:function(){var t="",n=this._iNode,r=this.get("depth");n._childrenRendered=!0,this.forSomeChildren(function(e,n,i){t+=e._getHTML(n,i.length,r+1)}),e.one("#"+n.id+" ."+g).setContent(t)},hold:function(){return this._iNode._held=this},release:function(){return this._iNode._held=null,this._root._poolReturn(this),this},getParent:function(){var e=this._iNode._parent;return e?this._root._poolFetch(e):null},getNextSibling:function(){var e=this._iNode._parent,t=e&&e.children||[],n=t.indexOf(this)+1;return n===0||n>t.length?null:this._root._poolFetch(t[n])},getPreviousSibling:function(){var e=this._iNode._parent,t=e&&e.children||[],n=t.indexOf(this)-1;return n<0?null:this._root._poolFetch(t[n])},focus:function(){return this._root.set(l,this)},blur:function(){return this._root.set(l,null)},toggle:function(){return this.set(u,!this.get(u))},expand:function(){return this.set(u,!0)},collapse:function(){return this.set(u,!1)},isRoot:function(){return this._root._tree===this._iNode},_getStateVal:function(e){var t=this._iNode;return this._state.get(e,s)||!t?this._state.get(e,o):t.hasOwnProperty(e)?t[e]:this._state.get(e,o)},_setStateVal:function(e,t){var n=this._iNode;this._state.get(e,s)||this._state.get(e,"initializing")||!n?this._state.add(e,o,t):n[e]=t}},{TEMPLATE:'<div id="{id}" class="{cname_node}" role="" aria-expanded="{expanded}"><div tabIndex="{tabIndex}" class="{cname_content}">{label}</div><div class="{cname_children}" role="group">{children}</div></div>',CNAME_NODE:d,CNAME_CONTENT:m,CNAME_CHILDREN:g,CNAME_COLLAPSED:y,CNAME_EXPANDED:b,CNAME_NOCHILDREN:w,CNAME_FIRSTCHILD:E,CNAME_LASTCHILD:S,CNAME_LOADING:x,ATTRS:{root:{_bypassProxy:!0,readOnly:!0,getter:function(){return this._root}},template:{validator:n.isString},label:{validator:n.isString,value:""},id:{readOnly:!0},depth:{_bypassProxy:!0,readOnly:!0,getter:function(){var e=0,t=this._iNode;while(t._parent)e+=1,t=t._parent;return e-1}},expanded:{_bypassProxy:!0,getter:"_expandedGetter",setter:"_expandedSetter"}}}),e.FlyweightTreeNode=N},"@VERSION@",{requires:["base-base","base-build","classnamemanager","event-focus"],skinnable:!1});
