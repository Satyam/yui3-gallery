YUI.add("gallery-flyweight-tree",function(e,t){"use strict";var n=e.Lang,r=".",i="_default",s=e.ClassNameManager.getClassName,o=function(e){return s("flyweight-tree-node",e)},u=o(""),a=o("children"),f=o("collapsed"),l=o("expanded"),c=o("no-children"),h=o("first-child"),p=o("last-child"),d=o("loading"),v="_bypassProxy",m="value",g=e.Array,y,b;y=function(){this._pool={},this._initialValues={}},y.ATTRS={defaultType:{value:"FlyweightTreeNode"},dynamicLoader:{validator:n.isFunction,value:null}},y.prototype={_tree:null,_pool:null,_domEvents:null,_loadConfig:function(t){var n=this;n._tree={children:e.clone(t)},n._initNodes(this._tree),n._domEvents&&e.Array.each(n._domEvents,function(e){n.after(e,n._afterDomEvent,n)})},_initNodes:function(t){var n=this;e.Array.each(t.children,function(r){r._parent=t,r.id=r.id||e.guid(),n._initNodes(r)})},_afterDomEvent:function(e){var t=this._poolFetchFromEvent(e);t&&(t.fire(e.type.split(":")[1],{domEvent:e.domEvent}),this._poolReturn(t))},_getTypeString:function(e){var t=e.type||i;if(!n.isString(t)){if(!n.isObject(t))throw"Node contains unknown type";t=t.NAME}return t},_poolFetch:function(e){var t,n=e._held,r=this._getTypeString(e);return n?n:(t=this._pool[r],t===undefined&&(t=this._pool[r]=[]),t.length?(n=t.pop(),n._slideTo(e),n):this._createNode(e))},_poolReturn:function(e){if(e._node._held)return;var t,n=this._getTypeString(e._node);t=this._pool[n],t&&t.push(e)},_createNode:function(t){var r,i=t.type||this.get("defaultType");n.isString(i)&&(i=e[i]);if(i){r=new i;if(r instanceof e.FlyweightTreeNode)return r._slideTo({}),e.Array.each(e.Object.keys(r._state.data),r._addLazyAttr,r),r._root=this,r._slideTo(t),r}return null},getRoot:function(){return this._poolFetch(this._tree)},_getHTML:function(){var e="",t=this.getRoot();return t.forSomeChildren(function(t,n,r){e+=t._getHTML(n,r.length,0)}),this._poolReturn(t),e},_findNodeByElement:function(t){var n=t.ancestor(r+b.CNAME_NODE,!0).get("id"),i=null,s=function(t){return t.id===n?(i=t,!0):t.children?e.Array.some(t.children,s):!1};return s(this._tree)?i:null},_poolFetchFromEvent:function(e){var t=this._findNodeByElement(e.domEvent.target);return t?this._poolFetch(t):null},_forSomeCfgNode:function(t,n){n=n||this;var r=function(i,s){return e.Array.some(i.children||[],function(e,i){return t.call(n,e,s,i),r(e,s+1)})};return r(this._tree,0)},forSomeNodes:function(e,t){t=t||this;var n=function(r,i){r.forSomeChildren(function(r,s,o){return e.call(t,r,i,s,o)===!0?!0:n(r,i+1)})};return n(this.getRoot(),1)}},e.FlyweightTreeManager=y,b=e.Base.create("flyweight-tree-node",e.Base,[],{_node:null,_root:null,_getHTML:function(e,t,r){var i=this,s=this._node,o=this.getAttrs(),d="",v=s.template,m=s.children&&s.children.length,g=[u],y=this.constructor;while(!v)v=y.TEMPLATE,y=y.superclass.constructor;return s._rendered=!0,m?o.expanded?(s._childrenRendered=!0,this.forSomeChildren(function(e,t,n){d+=e._getHTML(t,n.length,r+1)}),g.push(l)):g.push(f):this._root.get("dynamicLoader")&&!s.isLeaf?g.push(f):g.push(c),e===0&&g.push(h),e===t-1&&g.push(p),o.children=d,o.cname_node=g.join(" "),o.cname_children=a,n.sub(v,o)},_slideTo:function(e){this._node=e,this._stateProxy=e},forSomeChildren:function(e,t){var n=this._root,r=this._node.children,i,s;t=t||this,r&&r.length&&g.some(r,function(r,o,u){return i=n._poolFetch(r),s=e.call(t,i,o,u),n._poolReturn(i),s})},_expandedGetter:function(){return this._node.expanded!==!1},_expandedSetter:function(t){var n=this,r=n._node,i=n._root,s=e.one("#"+r.id),o=i.get("dynamicLoader");r.expanded=t=!!t;if(o&&!r.isLeaf&&(!r.children||!r.children.length)){this._loadDynamic();return}r.children&&r.children.length&&(t?(r._childrenRendered||n._renderChildren(),s.replaceClass(f,l)):s.replaceClass(l,f))},_loadDynamic:function(){var t=this,n=t._root;e.one("#"+this.get("id")).replaceClass(f,d),n.get("dynamicLoader").call(n,t,e.bind(t._dynamicLoadReturn,t))},_dynamicLoadReturn:function(t){var n=this,r=n._node,i=n._root;t?(r.children=t,i._initNodes(r),n._renderChildren()):r.isLeaf=!0,e.one("#"+r.id).replaceClass(d,r.isLeaf?c:l)},_renderChildren:function(){var t="",n=this._node,r=this.get("depth");n._childrenRendered=!0,this.forSomeChildren(function(e,n,i){t+=e._getHTML(n,i.length,r+1)}),e.one("#"+n.id+" ."+a).setContent(t)},hold:function(){return this._node._held=this},release:function(){return this._node._held=null,this._root._poolReturn(this),this},getParent:function(){var e=this._node._parent;return e?this._root._poolFetch(e):null},getNextSibling:function(){var e=this._node._parent,t=e&&e.children||[],n=t.indexOf(this)+1;return n===0||n>t.length?null:this._root._poolFetch(t[n])},getPreviousSibling:function(){var e=this._node._parent,t=e&&e.children||[],n=t.indexOf(this)-1;return n<0?null:this._root._poolFetch(t[n])},toggle:function(){return this.set("expanded",!this.get("expanded")),this},isRoot:function(){return this._root._tree===this._node},_getStateVal:function(e){var t=this._node;return this._state.get(e,v)||!t?this._state.get(e,m):t.hasOwnProperty(e)?t[e]:this._state.get(e,m)},_setStateVal:function(e,t){var n=this._node;this._state.get(e,v)||this._state.get(e,"initializing")||!n?this._state.add(e,m,t):n[e]=t}},{TEMPLATE:'<div id="{id}" class="{cname_node}"><div class="content">{label}</div><div class="{cname_children}">{children}</div></div>',CNAME_NODE:u,CNAME_CHILDREN:a,CNAME_COLLAPSED:f,CNAME_EXPANDED:l,CNAME_NOCHILDREN:c,CNAME_FIRSTCHILD:h,CNAME_LASTCHILD:p,CNAME_LOADING:d,ATTRS:{root:{_bypassProxy:!0,readOnly:!0,getter:function(){return this._root}},template:{validator:n.isString},label:{validator:n.isString,value:""},id:{readOnly:!0},depth:{_bypassProxy:!0,readOnly:!0,getter:function(){var e=0,t=this._node;while(t._parent)e+=1,t=t._parent;return e-1}},expanded:{_bypassProxy:!0,getter:"_expandedGetter",setter:"_expandedSetter"}}}),e.FlyweightTreeNode=b},"@VERSION@",{requires:["base-base","base-build","classnamemanager"],skinnable:!1});
